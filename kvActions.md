# kvActions
Most of the time using pdwatcher, I imagine, will be spent interacting with the databases, so I've pulled kv related stuff into this module before it overwhelms [[cliActions]].

## selectKv
Show all databases as Select-able list. Unfortunately Deno assigns a (seemingly) random ID to each Deno.Kv instance and it is hard to know which project they map back to.

Later in the workflow the user can assign a name to each KV. When we find a name for database we will show that, we'll also label the databases that have data with an emoji.

```ts
import { Select } from "https://deno.land/x/cliffy@v1.0.0-rc.4/prompt/select.ts";
import { Table } from "https://deno.land/x/cliffy@v1.0.0-rc.4/table/mod.ts";

import localKv from "localKv"
const { localKvs } = await localKv.process();

input.kvInfo = await Select.prompt({
    message: "Pick a KV",
    options: localKvs
        .toSorted((a,b) => {
            if(a.name && !b.name) return -1
            if(a.hasRecords && b.hasRecords) return 0
            if(a.hasRecords && !b.hasRecords) return -1
            return 1
        })
        .map(info => {
            const prefix = info.hasRecords ?  'âœ… ' : 'âŽ '
            return {
                name: info.name || prefix + info.id,
                value: info,
            }
        }),
});
```

## selectAction
- check: /kvInfo
    ```ts
    const action = await Select.prompt({
        message: "Action!",
        options: [
            { name: "Watch ðŸ‘€", value: "watch" },
            { name: "Latest", value: "latest" },
            { name: "Rename", value: "rename" },
        ],
    });
    $p.set(input, `/action/${action}`, true)
    ```

## actionWatch
    import { keypress, KeyPressEvent, } from "https://deno.land/x/cliffy@v1.0.0-rc.4/keypress/mod.ts";
    keypress().addEventListener("keydown", (event: KeyPressEvent) => {
        console.log(event.currentTarget);

        if (event.key === 'escape') {
            keypress().dispose();
            stopInterval = true;
        }
    });
- check: /action/watch
- and /kvInfo
- ```ts
    import { keypress, KeyPressEvent, } from "https://deno.land/x/cliffy@v1.0.0-rc.4/keypress/mod.ts";
    import objectSummary from "objectSummary"

    const renderObject = (name, summary) => Table.from([[name], [summary]]).render()

    let stopInterval = false;

    const changes = await Array.fromAsync(input.kvInfo.kv.list({ prefix: ['pd', 'output'] }))
    changes.map(async record => {
        let value = record.value;
        if(typeof value === 'string') (value = JSON.parse(value));
        const output = await objectSummary.process({obj:value})
        renderObject(record.key.at(-1), output.summary)
    })

    const interval = setInterval(async () => {
        if(stopInterval) clearInterval(interval)

        const records = input.kvInfo.kv.list({ prefix: ['pd', 'output'] })
        for await (const record of records){
            const alreadySeen = changes.some(({key, versionstamp}) => {
                return key.at(-1) === record.key.at(-1) && versionstamp === record.versionstamp
            })
            if(alreadySeen) {}
            else {
                changes.push(record)
                let value = record.value;
                if(typeof value === 'string') (value = JSON.parse(value));
                const output = await objectSummary.process({obj:value});
                renderObject(record.key.at(-1), output.summary)
            }
        }
    }, 1000)

    await keypress()
    stopInterval = true;
    console.log();
    ```

## actionAction
- check: /action/latest
- and /kvInfo
- ```ts
    console.log($p.get(input, '/kvInfo/records'))
    ```

## actionRename
Write to a pdwatcher object in the db to keep some meta data handy between runs
- check: /action/rename
- and /kvInfo
- ```ts
    const name: string = await Input.prompt("KV name");
    await input.kvInfo.kv.set(['pd', 'meta', 'name'], name)
    console.log('Name updated âœ…')
    ```


[//begin]: # "Autogenerated link references for markdown compatibility"
[cliActions]: cliActions "CLI Actions"
[//end]: # "Autogenerated link references"